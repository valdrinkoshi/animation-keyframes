<link rel="import" href="../polymer/polymer-element.html">
<script>
  class AnimationKeyframes extends Polymer.Element {
    static get is() {
      return 'animation-keyframes';
    }
    static get properties() {
      return {
        /** 
         * The name to be used for the class and keyframes.
         * The inversed animation will have "Inverse" appended to the animationName.
         * E.g. `animationName = "myAnimation"` generates:
         * ```css
         * .myAnimation { ... }
         * .myAnimationInverse { ... }
         * @keyframes myAnimation { ... }
         * @keyframes myAnimationInverse { ... }
         * ```
         * @property {string}
         */
        animationName: {
          type: String
        },
        /** 
         * Starting horizontal scale.
         * @property {Number}
         */
        fromScaleX: {
          type: Number
        },
        /** 
         * Starting vertical scale.
         * @property {Number}
         */
        fromScaleY: {
          type: Number
        },
        /** 
         * Ending horizontal scale.
         * @property {Number}
         */
        toScaleX: {
          type: Number
        },
        /** 
         * Ending vertical scale.
         * @property {Number}
         */
        toScaleY: {
          type: Number
        },
        /** 
         * Animation duration, in milliseconds.
         * @property {Number}
         */
        duration: {
          type: Number
        },
        /** 
         * Frames per second.
         * @property {Number}
         */
        fps: {
          type: Number,
          value: () => 60
        },
        /**
         * The ease function. Returns the eased `step`, which is passed as input.
         * Default is a quadratic ease, override to change.
         * Set to null to have a linear ease.
         * @property {Function}
         */
        easeCallback: {
          type: Number,
          value: () => step => 1 - Math.pow(1 - step, 4)
        },
        /** 
         * Sets from/to scale values.
         * Supported values: expand, collapse, vertical-expand, vertical-collapse,
         * horizontal-expand, horizontal-collapse.
         * @property {string}
         */
        preset: {
          type: String,
          observer: '_presetChanged'
        },
        /** 
         * Number of keyframes.
         * @property {Number}
         */
        framesCount: {
          type: Number,
          computed: '_computeFramesCount(duration, fps)'
        },
        /** 
         * The computed style text content.
         * @property {string}
         */
        styleTextContent: {
          type: String,
          notify: true,
          computed: '_computeStyleTextContent(animationName, framesCount, fromScaleX, fromScaleY, toScaleX, toScaleY)',
          observer: '_styleTextContentChanged'
        }
      }
    }

    connectedCallback() {
      super.connectedCallback();
      if (!this._styleEl) {
        this._styleEl = document.createElement('style');
        this._styleEl.textContent = this.styleTextContent;
        this.appendChild(this._styleEl);
      }
    }

    /**
     * @param {Number=} duration
     * @param {Number=} fps
     * @return {!Number}
     * @private
     */
    _computeFramesCount(duration, fps) {
      return duration > 0 && fps > 0 ? Math.round(duration * fps / 1000) : 0;
    }

    /**
     * @param {string=} animationName
     * @param {Number=} framesCount
     * @param {Number=} fromScaleX
     * @param {Number=} fromScaleY
     * @param {Number=} toScaleX
     * @param {Number=} toScaleY
     * @return {!string}
     * @private
     */
    _computeStyleTextContent(animationName, framesCount, fromScaleX, fromScaleY, toScaleX, toScaleY) {
      if (!framesCount || framesCount === 1 || !animationName)
        return '';
      // TODO check what's the max framesCount allowed for performant animations.

      const hScale = Number.isFinite(fromScaleX) && Number.isFinite(toScaleX);
      const vScale = Number.isFinite(fromScaleY) && Number.isFinite(toScaleY);
      if (!hScale && !vScale)
        return '';
      // Normalize scales to either keep their value or default to 1.
      if (!hScale)
        fromScaleX = toScaleX = 1;
      if (!vScale)
        fromScaleY = toScaleY = 1;

      const animation = [];
      const inverseAnimation = [];
      for (let i = 0; i < framesCount; i++) {
        const step = i / (framesCount - 1);
        const easedStep = this.easeCallback ? this.easeCallback(step) : step;

        const xScale = fromScaleX + (toScaleX - fromScaleX) * easedStep;
        const yScale = fromScaleY + (toScaleY - fromScaleY) * easedStep;

        const invScaleX = xScale !== 0 ? 1 / xScale : 10e3;
        const invScaleY = yScale !== 0 ? 1 / yScale : 10e3;

        const percentage = (100 * step).toFixed(5);

        animation.push(
          `
  ${percentage}% {
    transform: scale(${xScale.toFixed(5)}, ${yScale.toFixed(5)});
  }`);

        inverseAnimation.push(
          `
  ${percentage}% {
    transform: scale(${invScaleX.toFixed(5)}, ${invScaleY.toFixed(5)});
  }`);
      }
      return `
.${animationName} {
  overflow: hidden;
  will-change: transform;
  contain: content;
  animation-name: ${animationName};
  animation-duration: ${this.duration}ms;
  animation-timing-function: step-end;
}

.${animationName}Inverse {
  will-change: transform;
  contain: content;
  animation-name: ${animationName}Inverse;
  animation-duration: ${this.duration}ms;
  animation-timing-function: step-end;
}

@keyframes ${animationName} {${animation.join('')}
}

@keyframes ${animationName}Inverse {${inverseAnimation.join('')}
}`;
    }

    /**
     * Updates the style element's text content.
     * @param {string=} content
     * @private
     */
    _styleTextContentChanged(content) {
      if (this._styleEl)
        this._styleEl.textContent = content;
    }

    /**
     * Sets the from/to scale values if `preset` has a valid value.
     * @param {string=} preset
     * @private
     */
    _presetChanged(preset) {
      if (!preset)
        return;
      const expand = preset.endsWith('expand');
      const collapse = preset.endsWith('collapse');
      if (!expand && !collapse)
        return;
      const hScale = preset.startsWith('vertical-') === false;
      const vScale = preset.startsWith('horizontal-') === false;
      this.setProperties({
        fromScaleX: Number(!hScale || collapse),
        toScaleX: Number(!hScale || expand),
        fromScaleY: Number(!vScale || collapse),
        toScaleY: Number(!vScale || expand)
      });
    }
  }
  customElements.define(AnimationKeyframes.is, AnimationKeyframes);
</script>