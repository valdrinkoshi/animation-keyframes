<link rel="import" href="../polymer/polymer-element.html">
<script>
  class AnimationKeyframes extends Polymer.Element {
    static get is() {
      return 'animation-keyframes';
    }
    static get properties() {
      return {
        animationName: {
          type: String
        },
        preset: {
          type: String,
          observer: '_presetChanged'
        },
        fromScaleX: {
          type: Number
        },
        fromScaleY: {
          type: Number
        },
        toScaleX: {
          type: Number
        },
        toScaleY: {
          type: Number
        },
        duration: {
          type: Number
        },
        frameTime: {
          type: Number,
          value: () => (1000 / 60)
        },
        framesCount: {
          type: Number,
          notify: true,
          computed: '_computeFramesCount(duration, frameTime)'
        },
        keyframes: {
          type: String,
          notify: true,
          computed: '_computeKeyframes(animationName, framesCount, fromScaleX, fromScaleY, toScaleX, toScaleY)',
          observer: '_keyframesChanged'
        }
      }
    }

    connectedCallback() {
      super.connectedCallback();
      if (!this._keyframesEl) {
        this._keyframesEl = document.createElement('style');
        this._keyframesEl.textContent = this.keyframes;
        this.appendChild(this._keyframesEl);
      }
    }

    _computeFramesCount(duration, frameTime) {
      return duration > 0 && Number.isFinite(frameTime) ? Math.round(duration / frameTime) : 0;
    }

    _computeKeyframes(animationName, framesCount, fromScaleX, fromScaleY, toScaleX, toScaleY) {
      if (framesCount <= 1 || !animationName)
        return '';
      // TODO check what's the max framesCount allowed for performant animations.

      const hScale = Number.isFinite(fromScaleX) && Number.isFinite(toScaleX);
      const vScale = Number.isFinite(fromScaleY) && Number.isFinite(toScaleY);
      if (!hScale && !vScale)
        return '';
      // Normalize scales to either keep their value or default to 1.
      if (!hScale)
        fromScaleX = toScaleX = 1;
      if (!vScale)
        fromScaleY = toScaleY = 1;

      const animation = [];
      const inverseAnimation = [];
      for (let i = 0; i < framesCount; i++) {
        const step = i / (framesCount - 1);
        const easedStep = this._ease(step);

        const xScale = fromScaleX + (toScaleX - fromScaleX) * easedStep;
        const yScale = fromScaleY + (toScaleY - fromScaleY) * easedStep;

        const invScaleX = xScale !== 0 ? 1 / xScale : 10e3;
        const invScaleY = yScale !== 0 ? 1 / yScale : 10e3;

        const percentage = (100 * step).toFixed(5);

        animation.push(
          `
  ${percentage}% {
    transform: scale(${xScale.toFixed(5)}, ${yScale.toFixed(5)});
  }`);

        inverseAnimation.push(
          `
  ${percentage}% {
    transform: scale(${invScaleX.toFixed(5)}, ${invScaleY.toFixed(5)});
  }`);
      }
      return `
.${animationName} {
  overflow: hidden;
  will-change: transform;
  contain: content;
  animation-name: ${animationName};
  animation-duration: ${this.duration}ms;
  animation-timing-function: step-end;
}

.${animationName}Inverse {
  will-change: transform;
  contain: content;
  animation-name: ${animationName}Inverse;
  animation-duration: ${this.duration}ms;
  animation-timing-function: step-end;
}

@keyframes ${animationName} {${animation.join('')}
}

@keyframes ${animationName}Inverse {${inverseAnimation.join('')}
}`;
    }

    _ease(step) {
      return 1 - Math.pow(1 - step, 4);
    }

    _keyframesChanged(keyframes) {
      if (this._keyframesEl)
        this._keyframesEl.textContent = keyframes;
    }

    _presetChanged(preset) {
      if (!preset)
        return;
      const expand = preset.endsWith('expand');
      const collapse = preset.endsWith('collapse');
      if (!expand && !collapse)
        return;
      const hScale = preset.startsWith('vertical-') === false;
      const vScale = preset.startsWith('horizontal-') === false;
      this.setProperties({
        fromScaleX: Number(!hScale || collapse),
        toScaleX: Number(!hScale || expand),
        fromScaleY: Number(!vScale || collapse),
        toScaleY: Number(!vScale || expand)
      });
    }
  }
  customElements.define(AnimationKeyframes.is, AnimationKeyframes);
</script>